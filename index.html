<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório de Retrabalhos e Perdas 2D</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --shadow:0 10px 24px rgba(15, 23, 42, .06);
      --radius:18px;
      --radius2:14px;
      --btn:#0b0b0c;
      --btnText:#fff;
      --danger:#b91c1c;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:18px 14px 30px;
    }
    h1{
      font-size:22px;
      margin:6px 0 14px;
      font-weight:800;
      letter-spacing:.2px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
    }
    .field{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    input, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{ border-color:#94a3b8; }

    .col-4{ grid-column: span 4; }
    .col-6{ grid-column: span 6; }
    .col-12{ grid-column: span 12; }

    @media (max-width:760px){
      .col-4,.col-6{ grid-column: span 12; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:12px 0 12px;
    }
    .btn{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      box-shadow:var(--shadow);
      background:var(--card);
      color:var(--text);
    }
    .btn.primary{
      background:var(--btn);
      color:var(--btnText);
      border-color:transparent;
    }
    .btn:active{ transform:translateY(1px); }

    .hint{
      color:var(--muted);
      font-size:13px;
      margin:6px 0 10px;
      font-weight:600;
    }

    .editor{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
      box-shadow:var(--shadow);
    }
    .row{
      display:grid;
      grid-template-columns: 1.2fr .35fr 1fr 40px;
      gap:10px;
      align-items:center;
      padding:8px 6px;
      border-bottom:1px dashed #e9eef6;
    }
    .row:last-child{ border-bottom:0; }

    .row select,
    .row input,
    .row textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      font-size:14px;
      background:#fff;
      outline:none;
    }
    .row textarea{
      resize:none;
      min-height:42px;
      max-height:90px;
    }

    .del{
      width:36px;height:36px;
      display:grid;
      place-items:center;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--danger);
      cursor:pointer;
      font-size:22px;
      line-height:1;
      user-select:none;
    }

    .totbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      color:var(--muted);
      font-weight:800;
    }
    .totbar b{ color:var(--text); }

    hr.sep{
      margin:14px 0;
      height:1px;
      background:linear-gradient(to right, transparent, #d8e1ee, transparent);
      border:0;
    }

    /* CARTÃO DO RELATÓRIO (para PNG/compartilhar) */
    .report{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow:var(--shadow);
    }
    .reportTop{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
      margin-bottom:10px;
    }
    .leftHead{
      display:flex;
      gap:16px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .brand{
      font-weight:900;
      letter-spacing:.2px;
      font-size:18px;
      color:#111827;
      line-height:1.1;
    }
    .sub{
      font-weight:700;
      font-size:18px;
      color:#6b7280;
      line-height:1.1;
    }
    .meta{
      display:grid;
      gap:4px;
      font-size:16px;
      color:#111827;
    }
    .meta b{ font-weight:900; }
    .meta span{ color:#111827; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:15px;
      table-layout:fixed;
    }
    th, td{
      border:1px solid #e5e7eb;
      padding:10px 10px;
      vertical-align:top;
      word-wrap:break-word;
      overflow-wrap:break-word;
    }
    th{
      background:#f3f4f6;
      text-align:left;
      font-weight:900;
    }
    tfoot td{
      font-weight:900;
      background:#f3f4f6;
    }
    .foot{
      margin-top:10px;
      font-size:14px;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,.18);
      font-size:13px;
      display:none;
      z-index:99;
      max-width:min(560px, 92vw);
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Relatório de Retrabalhos e Perdas 2D</h1>

    <div class="grid">
      <div class="field col-12">
        <label for="setor">Setor</label>
        <input id="setor" />
      </div>

      <div class="field col-12">
        <label for="responsavel">Responsável</label>
        <input id="responsavel" placeholder="Ex.: F" />
      </div>

      <div class="field col-12">
        <label for="turno">Turno</label>
        <select id="turno">
          <option value="1º">1º</option>
          <option value="2º" selected>2º</option>
          <option value="3º">3º</option>
        </select>
      </div>

      <div class="field col-12">
        <label for="data">Data</label>
        <input id="data" type="date" />
      </div>

      <div class="field col-12">
        <label for="ramais">Ramais</label>
        <input id="ramais" />
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="addRowBtn">Adicionar linha</button>
      <button class="btn primary" id="genBtn">Gerar &amp; Compartilhar</button>
      <button class="btn" id="pngBtn">Baixar PNG</button>
    </div>

    <div class="hint">No editor abaixo, preencha os itens. A tabela final usa <b>texto puro</b>.</div>

    <div class="editor" id="editor"></div>

    <div class="totbar">
      <span class="hint" style="margin:0">Dica: apenas números em “Qtde”.</span>
      <span><b>Total:</b> <span id="totalEditor">0</span></span>
    </div>

    <hr class="sep" />

    <div class="report" id="report">
      <div class="reportTop">
        <div class="leftHead">
          <div class="brand">Grendene –<br>Impressão Digital</div>
          <div class="sub">Relatório de retrabalhos e<br>perdas 2D</div>
        </div>

        <div class="meta">
          <div><span style="color:#6b7280;">Responsável:</span> <b id="r_responsavel"></b></div>
          <div><span style="color:#6b7280;">Turno:</span> <b id="r_turno"></b></div>
          <div><span style="color:#6b7280;">Data:</span> <b id="r_data"></b></div>
          <div><span style="color:#6b7280;">Ramais:</span> <b id="r_ramais"></b></div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:40%">Motivo</th>
            <th style="width:14%">Qtde.</th>
            <th>Justificativa</th>
          </tr>
        </thead>
        <tbody id="tbodyReport"></tbody>
        <tfoot>
          <tr>
            <td style="text-align:left; font-weight:900;">TOTAL</td>
            <td id="r_total">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div class="foot">
        <span>Gerado em <span id="r_geradoEm"></span></span>
        <span></span>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- html2canvas para PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // ✅ Motivos atualizados (na ordem que você pediu)
    const MOTIVOS = [
      "Aplicação de base - imp",
      "Base - imp",
      "Falha de Impressão - imp",
      "Filete Branco - imp",
      "Logo Ipanema sem definição - imp",
      "Manchas - imp",
      "Número Trocado - imp",
      "Perda de Injeção - imp",
      "Sem Impressão - imp",
      "Sujeira no inferior da sola - imp",
      "Troca de Imagem - imp",
      "Lâminados falhas - imp"
    ];

    const editor = document.getElementById("editor");
    const totalEditorEl = document.getElementById("totalEditor");

    const responsavelEl = document.getElementById("responsavel");
    const turnoEl = document.getElementById("turno");
    const dataEl = document.getElementById("data");
    const ramaisEl = document.getElementById("ramais");

    const tbodyReport = document.getElementById("tbodyReport");
    const r_responsavel = document.getElementById("r_responsavel");
    const r_turno = document.getElementById("r_turno");
    const r_data = document.getElementById("r_data");
    const r_ramais = document.getElementById("r_ramais");
    const r_total = document.getElementById("r_total");
    const r_geradoEm = document.getElementById("r_geradoEm");

    const toastEl = document.getElementById("toast");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display = "none", 2200);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fmtDateBR(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      if(!y||!m||!d) return "";
      return `${d}/${m}/${y}`;
    }

    function nowBR(){
      const dt = new Date();
      const dd = String(dt.getDate()).padStart(2,"0");
      const mm = String(dt.getMonth()+1).padStart(2,"0");
      const yy = dt.getFullYear();
      const hh = String(dt.getHours()).padStart(2,"0");
      const mi = String(dt.getMinutes()).padStart(2,"0");
      const ss = String(dt.getSeconds()).padStart(2,"0");
      return `${dd}/${mm}/${yy}, ${hh}:${mi}:${ss}`;
    }

    function parseNumber(v){
      const n = Number(String(v).replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function buildOptions(selected){
      return MOTIVOS.map(m => {
        const sel = (m === selected) ? "selected" : "";
        return `<option value="${escapeHtml(m)}" ${sel}>${escapeHtml(m)}</option>`;
      }).join("");
    }

    function recalcEditorTotal(){
      const qtyInputs = editor.querySelectorAll('input[data-qty]');
      let sum = 0;
      qtyInputs.forEach(inp => sum += parseNumber(inp.value));
      totalEditorEl.textContent = String(sum);
      return sum;
    }

    function addRow(motivoInicial){
      const row = document.createElement("div");
      row.className = "row";

      const motivo = motivoInicial || MOTIVOS[0];

      row.innerHTML = `
        <select data-motivo>
          ${buildOptions(motivo)}
        </select>

        <input data-qty inputmode="numeric" placeholder="0" value="0" />

        <textarea data-just placeholder="Justificativa"></textarea>

        <div class="del" title="Remover">×</div>
      `;

      const qtyEl = row.querySelector('input[data-qty]');
      qtyEl.addEventListener("input", () => {
        qtyEl.value = qtyEl.value.replace(/[^\d.,]/g, "");
        recalcEditorTotal();
      });

      row.querySelector(".del").addEventListener("click", () => {
        row.remove();
        renderReport(); // atualiza relatório ao remover
      });

      row.querySelector('[data-motivo]').addEventListener("change", renderReport);
      row.querySelector('[data-just]').addEventListener("input", renderReport);
      qtyEl.addEventListener("input", renderReport);

      editor.appendChild(row);
      renderReport();
    }

    function getRows(){
      const rows = [];
      editor.querySelectorAll(".row").forEach(r => {
        const motivo = r.querySelector('[data-motivo]')?.value || "";
        const qty = parseNumber(r.querySelector('[data-qty]')?.value || "0");
        const just = r.querySelector('[data-just]')?.value || "";
        rows.push({ motivo, qty, just });
      });
      return rows;
    }

    function renderReport(){
      r_responsavel.textContent = (responsavelEl.value || "").trim();
      r_turno.textContent = turnoEl.value;
      r_data.textContent = fmtDateBR(dataEl.value);
      r_ramais.textContent = (ramaisEl.value || "").trim();
      r_geradoEm.textContent = nowBR();

      const rows = getRows();

      let total = 0;
      let html = "";

      if(rows.length === 0){
        html = `<tr><td colspan="3" style="color:#64748b; text-align:center; padding:14px;">Sem linhas. Clique em “Adicionar linha”.</td></tr>`;
      }else{
        rows.forEach(item => {
          total += item.qty;
          html += `
            <tr>
              <td>${escapeHtml(item.motivo)}</td>
              <td>${escapeHtml(item.qty)}</td>
              <td>${escapeHtml(item.just)}</td>
            </tr>
          `;
        });
      }

      tbodyReport.innerHTML = html;
      r_total.textContent = String(total);
      totalEditorEl.textContent = String(total);
      return total;
    }

    async function captureReportPng(){
      renderReport();
      const el = document.getElementById("report");
      const canvas = await html2canvas(el, {
        backgroundColor: "#ffffff",
        scale: 2,
        useCORS: true
      });
      return canvas;
    }

    async function downloadPNG(){
      try{
        const canvas = await captureReportPng();
        const a = document.createElement("a");
        const stamp = new Date().toISOString().slice(0,10);
        a.download = `relatorio-retrabalhos-perdas-2d_${stamp}.png`;
        a.href = canvas.toDataURL("image/png");
        a.click();
      }catch(e){
        console.error(e);
        toast("Não foi possível gerar o PNG.");
      }
    }

    async function shareReport(){
      try{
        const canvas = await captureReportPng();
        const blob = await new Promise(res => canvas.toBlob(res, "image/png", 1));
        const file = new File([blob], "relatorio.png", { type: "image/png" });

        const texto =
`Relatório de retrabalhos e perdas 2D
Responsável: ${responsavelEl.value || "-"}
Turno: ${turnoEl.value}
Data: ${fmtDateBR(dataEl.value) || "-"}
Ramais: ${ramaisEl.value || "-"}`;

        if(navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ title: "Relatório 2D", text: texto, files: [file] });
        }else{
          await downloadPNG();
          if(navigator.clipboard){
            await navigator.clipboard.writeText(texto);
            toast("PNG baixado. Texto copiado.");
          }else{
            toast("PNG baixado.");
          }
        }
      }catch(e){
        console.error(e);
        toast("Compartilhamento não suportado. Use “Baixar PNG”.");
      }
    }

    // Botões
    document.getElementById("addRowBtn").addEventListener("click", () => addRow());
    document.getElementById("pngBtn").addEventListener("click", downloadPNG);
    document.getElementById("genBtn").addEventListener("click", shareReport);

    // Inicial: 12 linhas (1 por motivo, na ordem)
    (function init(){
      // Se quiser deixar a data vazia como antes, não seto nada aqui.
      // Se quiser auto-preencher com hoje, descomente:
      // dataEl.value = new Date().toISOString().slice(0,10);

      MOTIVOS.forEach(m => addRow(m));
      renderReport();
    })();
  </script>
</body>
</html>
