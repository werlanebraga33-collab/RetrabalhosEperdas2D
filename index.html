<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Relatório de retrabalhos e perdas 2D</title>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f4f4;
    margin:0;
    padding:16px;
    color:#111;
  }

  .card{
    background:#fff;
    border-radius:10px;
    padding:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    margin-bottom:14px;
  }

  .top-title{
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:flex-start;
    border-bottom:1px solid #e7e7e7;
    padding-bottom:10px;
    margin-bottom:12px;
  }
  .top-title .left{
    font-size:20px;
    font-weight:700;
    line-height:1.15;
  }
  .top-title .right{
    font-size:20px;
    color:#6b6b6b;
    text-align:right;
    line-height:1.15;
  }

  .row{
    display:grid;
    grid-template-columns: 110px 1fr;
    gap:10px;
    align-items:center;
    margin:8px 0;
  }

  .label{
    color:#666;
  }

  input[type="text"], input[type="date"], select{
    width:100%;
    padding:10px 10px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
    box-sizing:border-box;
    background:#fff;
  }

  /* Ramais */
  .ramais-wrap{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .ramal-btn{
    display:flex;
    align-items:center;
    justify-content:center;
    width:48px;
    height:42px;
    border-radius:12px;
    border:1px solid #cfcfcf;
    background:#fff;
    font-size:16px;
    user-select:none;
    cursor:pointer;
  }
  .ramal-btn input{
    display:none;
  }
  .ramal-btn.active{
    border-color:#111;
    box-shadow:0 0 0 2px rgba(0,0,0,.08) inset;
    font-weight:700;
  }

  /* Tabela */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:14px;
  }
  th, td{
    border:1px solid #d8d8d8;
    padding:10px 8px;
    font-size:15px;
    vertical-align:middle;
  }
  th{
    background:#efefef;
    text-align:left;
    font-weight:700;
  }
  td.qtd-col{
    width:90px;
    text-align:center;
  }
  td.just-col{
    width:48%;
  }

  .qtd-input{
    width:64px;
    text-align:center;
    padding:8px 6px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
  }

  .just-input{
    width:100%;
    padding:10px 10px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
    box-sizing:border-box;
  }

  .tfoot-strong td{
    font-weight:800;
    background:#f5f5f5;
  }

  .buttons{
    display:flex;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }
  .btn{
    border:none;
    border-radius:12px;
    padding:12px 14px;
    font-size:15px;
    cursor:pointer;
    background:#e9eaee;
  }
  .btn.primary{
    background:#111;
    color:#fff;
  }

  .small-note{
    margin-top:10px;
    color:#777;
    font-size:13px;
  }

  /* Área do relatório para “foto” */
  #report{
    background:#fff;
  }
  /* Quando estiver em modo "foto", a tabela fica limpa */
  .photo-mode .qtd-input,
  .photo-mode .just-input,
  .photo-mode input[type="text"],
  .photo-mode input[type="date"],
  .photo-mode select{
    border:none !important;
    padding:0 !important;
    border-radius:0 !important;
    font-size:16px !important;
    background:transparent !important;
    box-shadow:none !important;
    outline:none !important;
  }
  .photo-mode .ramal-btn{
    border:none !important;
    width:auto !important;
    height:auto !important;
    padding:0 !important;
    border-radius:0 !important;
    background:transparent !important;
    box-shadow:none !important;
  }
</style>
</head>

<body>

<div class="card" id="report">
  <div class="top-title">
    <div class="left">Grendene –<br>Impressão<br>Digital</div>
    <div class="right">Relatório de retrabalhos<br>e<br>perdas 2D</div>
  </div>

  <div class="row">
    <div class="label">Responsável:</div>
    <div><input id="responsavel" type="text" /></div>
  </div>

  <div class="row">
    <div class="label">Turno:</div>
    <div>
      <select id="turno">
        <option value="1º">1º</option>
        <option value="2º" selected>2º</option>
        <option value="3º">3º</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="label">Data:</div>
    <div><input id="data" type="date"/></div>
  </div>

  <div class="row" style="align-items:start;">
    <div class="label" style="padding-top:10px;">Ramais:</div>
    <div class="ramais-wrap" id="ramaisWrap">
      <!-- Botões 1..6 -->
    </div>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>Motivo</th>
        <th class="qtd-col">Qtde.</th>
        <th class="just-col">Justificativa</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr class="tfoot-strong">
        <td>TOTAL</td>
        <td class="qtd-col" id="totalCell">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <div class="small-note" id="geradoEm"></div>
</div>

<div class="card">
  <div class="buttons">
    <button class="btn" onclick="limparTudo()">Limpar</button>
    <button class="btn primary" onclick="gerarECompartilhar()">Gerar & Compartilhar (WhatsApp)</button>
  </div>
  <div class="small-note">
    Dica: quantidade vazia fica limpa. Na “foto”, zeros não aparecem.
  </div>
</div>

<!-- html2canvas para gerar imagem -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  // ======= Motivos (ajuste livre) =======
  const motivos = [
    "Aplicação de base - imp",
    "Base - imp",
    "Falha de Impressão - imp",
    "Filete Branco - imp",
    "Logo sem definição - imp",
    "Manchas - imp",
    "Número Trocado - imp",
    "Perda de Injeção - imp",
    "Sem Impressão - imp",
    "Sujeira no inferior - imp",
    "Troca de Imagem - imp",
    "Lâminados falhas - imp"
  ];

  const tbody = document.getElementById("tbody");
  const totalCell = document.getElementById("totalCell");
  const geradoEm = document.getElementById("geradoEm");
  const report = document.getElementById("report");

  // ======= Ramais 1..6 como botões =======
  const ramaisWrap = document.getElementById("ramaisWrap");
  for (let i=1; i<=6; i++){
    const label = document.createElement("label");
    label.className = "ramal-btn";
    label.innerHTML = `<input type="checkbox" value="${i}"><span>${i}</span>`;
    label.addEventListener("click", (e)=>{
      // alterna visual
      setTimeout(()=> {
        const checked = label.querySelector("input").checked;
        label.classList.toggle("active", checked);
      }, 0);
    });
    ramaisWrap.appendChild(label);
  }

  function getRamaisSelecionados(){
    const checks = ramaisWrap.querySelectorAll('input[type="checkbox"]');
    const sel = [];
    checks.forEach(c => { if (c.checked) sel.push(c.value); });
    return sel;
  }

  // ======= Monta linhas =======
  motivos.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m}</td>
      <td class="qtd-col">
        <input class="qtd-input" type="number" min="0" step="1" inputmode="numeric" />
      </td>
      <td class="just-col">
        <input class="just-input" type="text" />
      </td>
    `;
    tbody.appendChild(tr);
  });

  // ======= Soma (vazio conta 0, mas não aparece) =======
  function calcularTotal(){
    let soma = 0;
    document.querySelectorAll(".qtd-input").forEach(inp=>{
      soma += Number(inp.value) || 0;
    });
    totalCell.textContent = soma;
  }

  document.addEventListener("input", (e)=>{
    if (e.target.classList && e.target.classList.contains("qtd-input")){
      // mantém campo limpo: nada de "0" automático
      if (e.target.value === "0") {
        // deixa 0 se o usuário digitou mesmo; mas pra ficar limpo, apaga se ele só clicou setinha pra 0
        // (se quiser manter 0 quando digitado, comente a linha abaixo)
        // e.target.value = "";
      }
      calcularTotal();
    }
  });

  // Data padrão hoje
  (function setHoje(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    document.getElementById("data").value = `${yyyy}-${mm}-${dd}`;
  })();

  // ======= Limpar =======
  function limparTudo(){
    document.getElementById("responsavel").value = "";
    document.getElementById("turno").value = "2º";
    // mantém data de hoje
    document.querySelectorAll(".qtd-input").forEach(i=> i.value = "");
    document.querySelectorAll(".just-input").forEach(i=> i.value = "");
    // ramais
    ramaisWrap.querySelectorAll('input[type="checkbox"]').forEach((c, idx)=>{
      c.checked = false;
      ramaisWrap.children[idx].classList.remove("active");
    });
    geradoEm.textContent = "";
    calcularTotal();
  }

  // ======= Formata relatório "foto": mostra texto estático e esconde zeros =======
  function aplicarModoFoto(){
    report.classList.add("photo-mode");

    // Troca inputs por texto "estático" (visualmente)
    // Responsável, Turno, Data: vamos colocar como texto (mas sem alterar seus valores)
    // Aqui, só "achatamos" o visual com CSS (sem bordas)
    // Para Qtde: esconder zeros (ficar vazio)
    document.querySelectorAll(".qtd-input").forEach(inp=>{
      const v = Number(inp.value) || 0;
      if (v === 0) inp.value = ""; // <- AQUI some o zero na foto
    });

    // Ramais: queremos no relatório "1, 3, 6"
    const sel = getRamaisSelecionados();
    // Criar uma linha visível igual a sua foto (texto ao lado)
    // Já temos "Ramais:" e os botões; no modo foto eles ficam como texto.
    // Melhor: substituir por texto simples temporário.
    const ramaisRow = ramaisWrap.parentElement; // div que contém os botões
    if (!document.getElementById("ramaisTextoFoto")){
      const span = document.createElement("div");
      span.id = "ramaisTextoFoto";
      span.style.marginTop = "10px";
      span.style.fontSize = "16px";
      span.style.fontWeight = "700";
      span.textContent = sel.length ? sel.join(", ") : "";
      // esconde botões e mostra texto
      ramaisWrap.style.display = "none";
      ramaisRow.appendChild(span);
    } else {
      document.getElementById("ramaisTextoFoto").textContent = sel.length ? sel.join(", ") : "";
      ramaisWrap.style.display = "none";
    }

    // "Gerado em ..."
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,"0");
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const yyyy = now.getFullYear();
    const hh = String(now.getHours()).padStart(2,"0");
    const mi = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    geradoEm.textContent = `Gerado em ${dd}/${mm}/${yyyy}, ${hh}:${mi}:${ss}`;
  }

  function removerModoFoto(){
    report.classList.remove("photo-mode");
    // volta botões dos ramais
    const texto = document.getElementById("ramaisTextoFoto");
    if (texto) texto.remove();
    ramaisWrap.style.display = "flex";
    calcularTotal(); // total continua correto
  }

  // ======= Gerar imagem + compartilhar =======
  async function gerarECompartilhar(){
    // Garante total
    calcularTotal();

    // aplica modo foto (zera visual de 0)
    aplicarModoFoto();

    try{
      const canvas = await html2canvas(report, {scale: 2, backgroundColor: "#ffffff"});
      const blob = await new Promise(res => canvas.toBlob(res, "image/png", 1.0));

      // tenta compartilhar direto (WhatsApp aparece no share sheet)
      const file = new File([blob], "relatorio_retrabalhos_perdas_2D.png", {type:"image/png"});

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: "Relatório de retrabalhos e perdas 2D",
          text: "Relatório de retrabalhos e perdas 2D"
        });
      } else {
        // fallback: baixa a imagem
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "relatorio_retrabalhos_perdas_2D.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert("Seu celular/navegador não permite compartilhar arquivo direto. A imagem foi baixada: envie no WhatsApp pela galeria.");
      }
    } catch (err){
      console.error(err);
      alert("Não foi possível gerar/compartilhar a imagem. Se quiser, tente no Chrome e permita pop-ups/compartilhar.");
    } finally {
      // volta ao modo normal (sem mexer no resto)
      removerModoFoto();
    }
  }

  // inicial
  calcularTotal();
</script>

</body>
</html>
