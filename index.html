<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Relatório de retrabalhos e perdas 2D</title>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f4f4;
    margin:0;
    padding:16px;
    color:#111;
  }

  .card{
    background:#fff;
    border-radius:10px;
    padding:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    margin-bottom:14px;
  }

  .top-title{
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:flex-start;
    border-bottom:1px solid #e7e7e7;
    padding-bottom:10px;
    margin-bottom:12px;
  }
  .top-title .left{
    font-size:20px;
    font-weight:700;
    line-height:1.15;
  }
  .top-title .right{
    font-size:20px;
    color:#6b6b6b;
    text-align:right;
    line-height:1.15;
  }

  .row{
    display:grid;
    grid-template-columns: 110px 1fr;
    gap:10px;
    align-items:center;
    margin:8px 0;
  }

  .label{ color:#666; }

  input[type="text"], input[type="date"], select{
    width:100%;
    padding:10px 10px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
    box-sizing:border-box;
    background:#fff;
  }

  /* Ramais */
  .ramais-wrap{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .ramal-btn{
    display:flex;
    align-items:center;
    justify-content:center;
    width:48px;
    height:42px;
    border-radius:12px;
    border:1px solid #cfcfcf;
    background:#fff;
    font-size:16px;
    user-select:none;
    cursor:pointer;
  }
  .ramal-btn input{ display:none; }
  .ramal-btn.active{
    border-color:#111;
    box-shadow:0 0 0 2px rgba(0,0,0,.08) inset;
    font-weight:700;
  }

  /* Tabela */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:14px;
    table-layout: fixed; /* importante pra controlar colunas */
  }
  th, td{
    border:1px solid #d8d8d8;
    padding:10px 8px;
    font-size:15px;
    vertical-align:top;
  }
  th{
    background:#efefef;
    text-align:left;
    font-weight:700;
  }

  /* Larguras das colunas (NORMAL) */
  th.col-motivo, td.col-motivo { width: 32%; }
  th.col-qtd,   td.col-qtd    { width: 16%; text-align:center; }
  th.col-just,  td.col-just   { width: 52%; }

  /* Evitar quebrar palavras feio */
  td.col-just, td.col-motivo{
    word-break: normal;
    overflow-wrap: break-word;
    hyphens: auto;
  }

  .qtd-input{
    width:76px;
    text-align:center;
    padding:8px 6px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
  }

  .just-input{
    width:100%;
    padding:10px 10px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
    box-sizing:border-box;
  }

  .tfoot-strong td{
    font-weight:800;
    background:#f5f5f5;
  }

  .buttons{
    display:flex;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }
  .btn{
    border:none;
    border-radius:12px;
    padding:12px 14px;
    font-size:15px;
    cursor:pointer;
    background:#e9eaee;
  }
  .btn.primary{
    background:#111;
    color:#fff;
  }

  .small-note{
    margin-top:10px;
    color:#777;
    font-size:13px;
  }

  /* Área do relatório */
  #report{
    background:#fff;
  }

  /* Modo foto: tira borda dos inputs e deixa como texto */
  .photo-mode .qtd-input,
  .photo-mode .just-input,
  .photo-mode input[type="text"],
  .photo-mode input[type="date"],
  .photo-mode select{
    border:none !important;
    padding:0 !important;
    border-radius:0 !important;
    font-size:16px !important;
    background:transparent !important;
    box-shadow:none !important;
    outline:none !important;
  }
  .photo-mode .ramal-btn{
    border:none !important;
    width:auto !important;
    height:auto !important;
    padding:0 !important;
    border-radius:0 !important;
    background:transparent !important;
    box-shadow:none !important;
  }

  /* ======= PREVIEW MODAL ======= */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index: 9999;
  }
  .modal.open{ display:flex; }

  .modal-box{
    background:#fff;
    border-radius:14px;
    width:min(980px, 96vw);
    max-height: 92vh;
    overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    display:flex;
    flex-direction:column;
  }
  .modal-head{
    padding:12px 14px;
    border-bottom:1px solid #eee;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .modal-head strong{ font-size:15px; }
  .modal-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .modal-body{
    padding:12px;
    overflow:auto;
    background:#fafafa;
  }
  .modal-body img{
    width:100%;
    height:auto;
    display:block;
    border-radius:10px;
    background:#fff;
  }

  /* ======= “Palco” de captura (fora da tela) ======= */
  #photoStage{
    position: fixed;
    left: -99999px;
    top: 0;
    width: 900px;        /* <<< AQUI garante a foto larga */
    background:#fff;
  }
</style>
</head>

<body>

<div class="card" id="report">
  <div class="top-title">
    <div class="left">Grendene –<br>Impressão<br>Digital</div>
    <div class="right">Relatório de retrabalhos<br>e<br>perdas 2D</div>
  </div>

  <div class="row">
    <div class="label">Responsável:</div>
    <div><input id="responsavel" type="text" value=""/></div>
  </div>

  <div class="row">
    <div class="label">Turno:</div>
    <div>
      <select id="turno">
        <option value="1º">1º</option>
        <option value="2º" selected>2º</option>
        <option value="3º">3º</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="label">Data:</div>
    <div><input id="data" type="date"/></div>
  </div>

  <div class="row" style="align-items:start;">
    <div class="label" style="padding-top:10px;">Ramais:</div>
    <div class="ramais-wrap" id="ramaisWrap"></div>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th class="col-motivo">Motivo</th>
        <th class="col-qtd">Qtde.</th>
        <th class="col-just">Justificativa</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr class="tfoot-strong">
        <td>TOTAL</td>
        <td class="col-qtd" id="totalCell">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <div class="small-note" id="geradoEm"></div>
</div>

<div class="card">
  <div class="buttons">
    <button class="btn" onclick="limparTudo()">Limpar</button>
    <button class="btn primary" onclick="abrirPreview()">Gerar Prévia</button>
  </div>
  <div class="small-note">
    A prévia mostra a “foto” do relatório antes de enviar. Zeros não aparecem.
  </div>
</div>

<!-- Modal de prévia -->
<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-head">
      <strong>Prévia do relatório</strong>
      <div class="modal-actions">
        <button class="btn" onclick="fecharPreview()">Fechar</button>
        <button class="btn" onclick="baixarImagem()">Baixar</button>
        <button class="btn primary" onclick="compartilharImagem()">Compartilhar (WhatsApp)</button>
      </div>
    </div>
    <div class="modal-body">
      <img id="previewImg" alt="Prévia do relatório"/>
    </div>
  </div>
</div>

<!-- Palco de captura (fora da tela) -->
<div id="photoStage"></div>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const motivos = [
    "Aplicação de base - imp",
    "Base - imp",
    "Falha de Impressão - imp",
    "Filete Branco - imp",
    "Logo sem definição - imp",
    "Manchas - imp",
    "Número Trocado - imp",
    "Perda de Injeção - imp",
    "Sem Impressão - imp",
    "Sujeira no inferior - imp",
    "Troca de Imagem - imp",
    "Lâminados falhas - imp"
  ];

  const tbody = document.getElementById("tbody");
  const totalCell = document.getElementById("totalCell");
  const geradoEm = document.getElementById("geradoEm");
  const ramaisWrap = document.getElementById("ramaisWrap");
  const modal = document.getElementById("modal");
  const previewImg = document.getElementById("previewImg");
  const photoStage = document.getElementById("photoStage");

  let lastBlob = null; // guarda a imagem gerada pra baixar/compartilhar

  // Ramais 1..6
  for (let i=1; i<=6; i++){
    const label = document.createElement("label");
    label.className = "ramal-btn";
    label.innerHTML = `<input type="checkbox" value="${i}"><span>${i}</span>`;
    label.addEventListener("click", ()=>{
      setTimeout(()=> {
        const checked = label.querySelector("input").checked;
        label.classList.toggle("active", checked);
      }, 0);
    });
    ramaisWrap.appendChild(label);
  }

  function getRamaisSelecionados(){
    const checks = ramaisWrap.querySelectorAll('input[type="checkbox"]');
    const sel = [];
    checks.forEach(c => { if (c.checked) sel.push(c.value); });
    return sel;
  }

  // Monta linhas
  motivos.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="col-motivo">${m}</td>
      <td class="col-qtd">
        <input class="qtd-input" type="number" min="0" step="1" inputmode="numeric">
      </td>
      <td class="col-just">
        <input class="just-input" type="text">
      </td>
    `;
    tbody.appendChild(tr);
  });

  function calcularTotal(){
    let soma = 0;
    document.querySelectorAll(".qtd-input").forEach(inp=>{
      soma += Number(inp.value) || 0;
    });
    totalCell.textContent = soma;
  }

  document.addEventListener("input", (e)=>{
    if (e.target.classList && e.target.classList.contains("qtd-input")){
      calcularTotal();
    }
  });

  // Data de hoje
  (function setHoje(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    document.getElementById("data").value = `${yyyy}-${mm}-${dd}`;
  })();

  function limparTudo(){
    document.getElementById("responsavel").value = "";
    document.getElementById("turno").value = "2º";
    // mantém data de hoje
    document.querySelectorAll(".qtd-input").forEach(i=> i.value = "");
    document.querySelectorAll(".just-input").forEach(i=> i.value = "");
    ramaisWrap.querySelectorAll('input[type="checkbox"]').forEach((c, idx)=>{
      c.checked = false;
      ramaisWrap.children[idx].classList.remove("active");
    });
    geradoEm.textContent = "";
    calcularTotal();
  }

  function formatGeradoEm(){
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,"0");
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const yyyy = now.getFullYear();
    const hh = String(now.getHours()).padStart(2,"0");
    const mi = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    return `Gerado em ${dd}/${mm}/${yyyy}, ${hh}:${mi}:${ss}`;
  }

  // ======== Clona o relatório para o “palco” e prepara modo foto (largo + sem zeros) ========
  function buildPhotoClone(){
    // Limpa palco
    photoStage.innerHTML = "";

    // Clona cartão do relatório (report)
    const report = document.getElementById("report");
    const clone = report.cloneNode(true);

    // força modo foto
    clone.classList.add("photo-mode");

    // Ajuste: no clone, "Ramais:" vira texto "1, 5, 6"
    const ramaisSel = getRamaisSelecionados();
    const ramaisRow = clone.querySelector("#ramaisWrap");
    if (ramaisRow){
      ramaisRow.innerHTML = "";
      const span = document.createElement("div");
      span.style.fontSize = "16px";
      span.style.fontWeight = "700";
      span.textContent = ramaisSel.length ? ramaisSel.join(", ") : "";
      ramaisRow.appendChild(span);
    }

    // No clone: inputs viram valores “limpos”
    // Responsável
    const resp = document.getElementById("responsavel").value || "";
    const respClone = clone.querySelector("#responsavel");
    if (respClone){
      respClone.outerHTML = `<span style="font-weight:700;">${escapeHtml(resp)}</span>`;
    }

    // Turno
    const turno = document.getElementById("turno").value;
    const turnoClone = clone.querySelector("#turno");
    if (turnoClone){
      turnoClone.outerHTML = `<span style="font-weight:700;">${escapeHtml(turno)}</span>`;
    }

    // Data
    const data = document.getElementById("data").value || "";
    const dataClone = clone.querySelector("#data");
    if (dataClone){
      dataClone.outerHTML = `<span style="font-weight:700;">${escapeHtml(data)}</span>`;
    }

    // Qtde + Justificativa: esconder zeros (Qtde=0 vira vazio), manter justificativa visível
    const rows = clone.querySelectorAll("tbody tr");
    const qtdInputsOriginal = document.querySelectorAll(".qtd-input");
    const justInputsOriginal = document.querySelectorAll(".just-input");

    rows.forEach((tr, idx)=>{
      const qtd = Number(qtdInputsOriginal[idx]?.value) || 0;
      const just = (justInputsOriginal[idx]?.value || "").trim();

      // Coluna qtd (vazio se 0)
      const qtdCell = tr.querySelector(".col-qtd");
      if (qtdCell){
        qtdCell.innerHTML = `<div style="font-weight:700;">${qtd === 0 ? "" : String(qtd)}</div>`;
      }

      // Coluna justificativa (texto)
      const justCell = tr.querySelector(".col-just");
      if (justCell){
        justCell.innerHTML = `<div>${escapeHtml(just)}</div>`;
      }
    });

    // Total
    const total = totalCell.textContent || "0";
    const totalClone = clone.querySelector("#totalCell");
    if (totalClone) totalClone.textContent = total;

    // Gerado em
    const gerado = clone.querySelector("#geradoEm");
    if (gerado) gerado.textContent = formatGeradoEm();

    // Colunas mais “amigas” na FOTO: dá ainda mais espaço pra justificativa
    const ths = clone.querySelectorAll("th");
    ths.forEach(th=>{
      // nada aqui, só garantindo existir
    });

    // Anexa clone no palco (com largura fixa 900px)
    photoStage.appendChild(clone);

    return clone;
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // ======== Gera imagem (larga) e abre prévia ========
  async function abrirPreview(){
    calcularTotal();
    lastBlob = null;

    const clone = buildPhotoClone();

    try{
      const canvas = await html2canvas(clone, {
        scale: 3,                 // <<< mais resolução
        backgroundColor: "#ffffff",
        width: 900               // <<< garante largura
      });

      const blob = await new Promise(res => canvas.toBlob(res, "image/png", 1.0));
      lastBlob = blob;

      const url = URL.createObjectURL(blob);
      previewImg.src = url;

      modal.classList.add("open");
    } catch (err){
      console.error(err);
      alert("Não foi possível gerar a prévia. Tente no Chrome.");
    }
  }

  function fecharPreview(){
    modal.classList.remove("open");
    if (previewImg.src){
      try{ URL.revokeObjectURL(previewImg.src); }catch(e){}
      previewImg.src = "";
    }
  }

  function baixarImagem(){
    if (!lastBlob){
      alert("Gere a prévia primeiro.");
      return;
    }
    const url = URL.createObjectURL(lastBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "relatorio_retrabalhos_perdas_2D.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function compartilharImagem(){
    if (!lastBlob){
      alert("Gere a prévia primeiro.");
      return;
    }
    const file = new File([lastBlob], "relatorio_retrabalhos_perdas_2D.png", {type:"image/png"});

    try{
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: "Relatório de retrabalhos e perdas 2D",
          text: "Relatório de retrabalhos e perdas 2D"
        });
      } else {
        // fallback: baixa e manda manual
        baixarImagem();
        alert("Seu celular/navegador não permite compartilhar arquivo direto. A imagem foi baixada: envie no WhatsApp pela galeria.");
      }
    } catch (err){
      console.error(err);
      alert("Compartilhamento cancelado ou não suportado.");
    }
  }

  calcularTotal();
</script>

</body>
</html>
