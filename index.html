<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Relatório de retrabalhos e perdas 2D</title>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f4f4;
    margin:0;
    padding:16px;
    color:#111;
  }

  .card{
    background:#fff;
    border-radius:10px;
    padding:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    margin-bottom:14px;
  }

  /* ===== Cabeçalho tela normal ===== */
  .top-title{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    border-bottom:1px solid #e7e7e7;
    padding-bottom:10px;
    margin-bottom:12px;
  }
  .top-title .left{
    font-size:20px;
    font-weight:800;
    white-space:nowrap;
  }
  .top-title .right{
    font-size:18px;
    color:#6b6b6b;
    text-align:right;
    white-space:nowrap;
  }

  /* ===== Form (tela normal) ===== */
  .row{
    display:grid;
    grid-template-columns: 110px 1fr;
    gap:10px;
    align-items:center;
    margin:8px 0;
  }
  .label{ color:#666; }

  input[type="text"], input[type="date"], select{
    width:100%;
    padding:10px 10px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
    box-sizing:border-box;
    background:#fff;
  }

  /* ===== Ramais (botões) ===== */
  .ramais-wrap{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .ramal-btn{
    display:flex;
    align-items:center;
    justify-content:center;
    width:48px;
    height:42px;
    border-radius:12px;
    border:1px solid #cfcfcf;
    background:#fff;
    font-size:16px;
    user-select:none;
    cursor:pointer;
  }
  .ramal-btn input{ display:none; }
  .ramal-btn.active{
    border-color:#111;
    box-shadow:0 0 0 2px rgba(0,0,0,.08) inset;
    font-weight:700;
  }

  /* ===== Tabela tela normal ===== */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:14px;
    table-layout: fixed;
  }
  th, td{
    border:1px solid #d8d8d8;
    padding:10px 8px;
    font-size:15px;
    vertical-align:top;
  }
  th{
    background:#efefef;
    text-align:left;
    font-weight:700;
  }
  th.col-motivo, td.col-motivo { width: 34%; }
  th.col-qtd,   td.col-qtd    { width: 16%; text-align:center; }
  th.col-just,  td.col-just   { width: 50%; }

  td.col-just, td.col-motivo{
    word-break: normal;
    overflow-wrap: break-word;
    hyphens: auto;
  }

  .qtd-input{
    width:76px;
    text-align:center;
    padding:8px 6px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
  }

  .just-input{
    width:100%;
    padding:10px 10px;
    border:1px solid #cfcfcf;
    border-radius:10px;
    font-size:16px;
    outline:none;
    box-sizing:border-box;
  }

  .tfoot-strong td{
    font-weight:800;
    background:#f5f5f5;
  }

  .buttons{
    display:flex;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }
  .btn{
    border:none;
    border-radius:12px;
    padding:12px 14px;
    font-size:15px;
    cursor:pointer;
    background:#e9eaee;
  }
  .btn.primary{
    background:#111;
    color:#fff;
  }

  .small-note{
    margin-top:10px;
    color:#777;
    font-size:13px;
  }

  /* ======== Modal de prévia ======== */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index: 9999;
  }
  .modal.open{ display:flex; }

  .modal-box{
    background:#fff;
    border-radius:14px;
    width:min(980px, 96vw);
    max-height: 92vh;
    overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    display:flex;
    flex-direction:column;
  }
  .modal-head{
    padding:12px 14px;
    border-bottom:1px solid #eee;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .modal-head strong{ font-size:15px; }
  .modal-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .modal-body{
    padding:12px;
    overflow:auto;
    background:#fafafa;
  }
  .modal-body img{
    width:100%;
    height:auto;
    display:block;
    border-radius:10px;
    background:#fff;
  }

  /* ======== Palco de captura (fora da tela) ======== */
  #photoStage{
    position: fixed;
    left: -99999px;
    top: 0;
    width: 980px;
    background:#fff;
  }

  /* ======== RELATÓRIO DA FOTO ======== */
  .photo-card{
    background:#fff;
    border-radius:0;
    box-shadow:none;
    padding:18px 18px 14px;
  }

  .photo-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:14px;
    border-bottom:1px solid #e7e7e7;
    padding-bottom:14px;
    margin-bottom:16px;
  }
  .photo-header .h-left{
    font-size:34px;
    font-weight:900;
    white-space:nowrap;
  }
  .photo-header .h-right{
    font-size:28px;
    color:#6b6b6b;
    white-space:nowrap;
  }

  .meta-grid{
    display:grid;
    grid-template-columns: 1.6fr 0.6fr 0.8fr 1.2fr;
    gap:14px 22px;
    align-items:center;
    margin:12px 0 16px;
    font-size:22px;
  }
  .meta-item .m-label{
    color:#666;
    margin-right:8px;
  }
  .meta-item .m-value{
    font-weight:900;
  }

  .photo-table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
  }
  .photo-table th, .photo-table td{
    border:1px solid #d8d8d8;
    padding:12px 12px;
    vertical-align:middle;
  }

  /* >>> AUMENTO DO CABEÇALHO DA TABELA <<< */
  .photo-table th{
    background:#efefef;
    font-weight:900;
    font-size:23px;     /* MAIOR */
    line-height: 1.15;
  }

  /* >>> AUMENTO DO CORPO DA TABELA (MOTIVO + JUSTIFICATIVA) <<< */
  .photo-table td{
    font-size:22px;     /* MAIOR */
    line-height: 1.25;  /* MAIS LEGÍVEL */
  }

  .photo-table th.col-motivo, .photo-table td.col-motivo { width: 28%; }
  .photo-table th.col-qtd,    .photo-table td.col-qtd    { width: 12%; text-align:center; }
  .photo-table th.col-just,   .photo-table td.col-just   { width: 60%; }

  /* Quantidade ainda mais destacada */
  .photo-table td.col-qtd strong{
    font-size:24px;     /* MAIOR */
    font-weight:900;
  }

  /* Justificativa centralizada (H e V) */
  .photo-table td.col-just{
    padding:0;
  }
  .jwrap{
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    width:100%;
    height:100%;
    padding:12px 12px;
    box-sizing:border-box;
    overflow-wrap: break-word;
    word-break: normal;
    hyphens: auto;
    min-height: 38px;
  }

  .photo-footer{
    margin-top:14px;
    color:#666;
    font-size:16px;
  }

  @media (max-width: 720px){
    .top-title .left, .top-title .right { white-space:normal; }
  }
</style>
</head>

<body>

<div class="card" id="appCard">
  <div class="top-title">
    <div class="left">Grendene – Impressão Digital</div>
    <div class="right">Relatório de retrabalhos e perdas 2D</div>
  </div>

  <div class="row">
    <div class="label">Responsável:</div>
    <div><input id="responsavel" type="text" /></div>
  </div>

  <div class="row">
    <div class="label">Turno:</div>
    <div>
      <select id="turno">
        <option value="1º">1º</option>
        <option value="2º" selected>2º</option>
        <option value="3º">3º</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="label">Data:</div>
    <div><input id="data" type="date"/></div>
  </div>

  <div class="row" style="align-items:start;">
    <div class="label" style="padding-top:10px;">Ramais:</div>
    <div class="ramais-wrap" id="ramaisWrap"></div>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th class="col-motivo">Motivo</th>
        <th class="col-qtd">Qtde.</th>
        <th class="col-just">Justificativa</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr class="tfoot-strong">
        <td>TOTAL</td>
        <td class="col-qtd" id="totalCell">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <div class="small-note" id="statusHint"></div>
</div>

<div class="card">
  <div class="buttons">
    <button class="btn" onclick="limparTudo()">Limpar</button>
    <button class="btn primary" onclick="abrirPreview()">Gerar Prévia</button>
  </div>
  <div class="small-note">
    A prévia mostra a “foto” do relatório antes de enviar. Qtde vazia fica limpa e 0 não aparece na foto.
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-head">
      <strong>Prévia do relatório</strong>
      <div class="modal-actions">
        <button class="btn" onclick="fecharPreview()">Fechar</button>
        <button class="btn" onclick="baixarImagem()">Baixar</button>
        <button class="btn primary" onclick="compartilharImagem()">Compartilhar (WhatsApp)</button>
      </div>
    </div>
    <div class="modal-body">
      <img id="previewImg" alt="Prévia do relatório"/>
    </div>
  </div>
</div>

<div id="photoStage"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const motivos = [
    "Aplicação de base - imp",
    "Base - imp",
    "Falha de Impressão - imp",
    "Filete Branco - imp",
    "Logo sem definição - imp",
    "Manchas - imp",
    "Número Trocado - imp",
    "Perda de Injeção - imp",
    "Sem Impressão - imp",
    "Sujeira no inferior - imp",
    "Troca de Imagem - imp",
    "Lâminados falhas - imp"
  ];

  const tbody = document.getElementById("tbody");
  const totalCell = document.getElementById("totalCell");
  const ramaisWrap = document.getElementById("ramaisWrap");
  const modal = document.getElementById("modal");
  const previewImg = document.getElementById("previewImg");
  const photoStage = document.getElementById("photoStage");
  const statusHint = document.getElementById("statusHint");

  let lastBlob = null;

  for (let i=1; i<=6; i++){
    const label = document.createElement("label");
    label.className = "ramal-btn";
    label.innerHTML = `<input type="checkbox" value="${i}"><span>${i}</span>`;
    label.addEventListener("click", ()=>{
      setTimeout(()=> {
        const checked = label.querySelector("input").checked;
        label.classList.toggle("active", checked);
      }, 0);
    });
    ramaisWrap.appendChild(label);
  }

  function getRamaisSelecionados(){
    const checks = ramaisWrap.querySelectorAll('input[type="checkbox"]');
    const sel = [];
    checks.forEach(c => { if (c.checked) sel.push(c.value); });
    return sel;
  }

  motivos.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="col-motivo">${m}</td>
      <td class="col-qtd">
        <input class="qtd-input" type="number" min="0" step="1" inputmode="numeric" placeholder="">
      </td>
      <td class="col-just">
        <input class="just-input" type="text" placeholder="">
      </td>
    `;
    tbody.appendChild(tr);
  });

  function calcularTotal(){
    let soma = 0;
    document.querySelectorAll(".qtd-input").forEach(inp=>{
      soma += Number(inp.value) || 0;
    });
    totalCell.textContent = soma;
  }

  document.addEventListener("input", (e)=>{
    if (e.target.classList && e.target.classList.contains("qtd-input")){
      calcularTotal();
    }
  });

  (function setHoje(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    document.getElementById("data").value = `${yyyy}-${mm}-${dd}`;
  })();

  function limparTudo(){
    document.getElementById("responsavel").value = "";
    document.getElementById("turno").value = "2º";
    document.querySelectorAll(".qtd-input").forEach(i=> i.value = "");
    document.querySelectorAll(".just-input").forEach(i=> i.value = "");
    ramaisWrap.querySelectorAll('input[type="checkbox"]').forEach((c, idx)=>{
      c.checked = false;
      ramaisWrap.children[idx].classList.remove("active");
    });
    calcularTotal();
    statusHint.textContent = "";
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function formatDateBR(iso){
    if (!iso || !iso.includes("-")) return "";
    const [yyyy, mm, dd] = iso.split("-");
    return `${dd}/${mm}/${yyyy}`;
  }

  function formatGeradoEm(){
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,"0");
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const yyyy = now.getFullYear();
    const hh = String(now.getHours()).padStart(2,"0");
    const mi = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    return `Gerado em ${dd}/${mm}/${yyyy}, ${hh}:${mi}:${ss}`;
  }

  function buildPhotoNode(){
    photoStage.innerHTML = "";

    const responsavel = document.getElementById("responsavel").value || "";
    const turno = document.getElementById("turno").value || "";
    const dataIso = document.getElementById("data").value || "";
    const dataBR = formatDateBR(dataIso);
    const ramais = getRamaisSelecionados().join(", ");

    const qtdInputs = document.querySelectorAll(".qtd-input");
    const justInputs = document.querySelectorAll(".just-input");

    const wrapper = document.createElement("div");
    wrapper.className = "photo-card";

    wrapper.innerHTML = `
      <div class="photo-header">
        <div class="h-left">Grendene – Impressão Digital</div>
        <div class="h-right">Relatório de retrabalhos e perdas 2D</div>
      </div>

      <div class="meta-grid">
        <div class="meta-item"><span class="m-label">Responsável:</span> <span class="m-value">${escapeHtml(responsavel)}</span></div>
        <div class="meta-item"><span class="m-label">Turno:</span> <span class="m-value">${escapeHtml(turno)}</span></div>
        <div class="meta-item"><span class="m-label">Data:</span> <span class="m-value">${escapeHtml(dataBR)}</span></div>
        <div class="meta-item"><span class="m-label">Ramais:</span> <span class="m-value">${escapeHtml(ramais)}</span></div>
      </div>

      <table class="photo-table">
        <thead>
          <tr>
            <th class="col-motivo">Motivo</th>
            <th class="col-qtd">Qtde.</th>
            <th class="col-just">Justificativa</th>
          </tr>
        </thead>
        <tbody id="photoBody"></tbody>
        <tfoot>
          <tr class="tfoot-strong">
            <td>TOTAL</td>
            <td class="col-qtd">${escapeHtml(totalCell.textContent || "0")}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div class="photo-footer">${escapeHtml(formatGeradoEm())}</div>
    `;

    const photoBody = wrapper.querySelector("#photoBody");

    motivos.forEach((motivo, idx)=>{
      const qtd = Number(qtdInputs[idx]?.value) || 0;
      const just = (justInputs[idx]?.value || "").trim();
      const qtdTxt = (qtd === 0 ? "" : String(qtd));

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-motivo">${escapeHtml(motivo)}</td>
        <td class="col-qtd"><strong>${escapeHtml(qtdTxt)}</strong></td>
        <td class="col-just"><div class="jwrap">${escapeHtml(just)}</div></td>
      `;
      photoBody.appendChild(tr);
    });

    photoStage.appendChild(wrapper);
    return wrapper;
  }

  async function abrirPreview(){
    calcularTotal();
    lastBlob = null;
    statusHint.textContent = "Gerando prévia...";

    const node = buildPhotoNode();

    try{
      const canvas = await html2canvas(node, {
        scale: 3,
        backgroundColor: "#ffffff",
        width: 980
      });

      const blob = await new Promise(res => canvas.toBlob(res, "image/png", 1.0));
      lastBlob = blob;

      const url = URL.createObjectURL(blob);
      previewImg.src = url;

      modal.classList.add("open");
      statusHint.textContent = "";
    } catch (err){
      console.error(err);
      statusHint.textContent = "";
      alert("Não foi possível gerar a prévia. Tente no Chrome.");
    }
  }

  function fecharPreview(){
    modal.classList.remove("open");
    if (previewImg.src){
      try{ URL.revokeObjectURL(previewImg.src); }catch(e){}
      previewImg.src = "";
    }
  }

  function baixarImagem(){
    if (!lastBlob){
      alert("Gere a prévia primeiro.");
      return;
    }
    const url = URL.createObjectURL(lastBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "relatorio_retrabalhos_perdas_2D.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function compartilharImagem(){
    if (!lastBlob){
      alert("Gere a prévia primeiro.");
      return;
    }
    const file = new File([lastBlob], "relatorio_retrabalhos_perdas_2D.png", {type:"image/png"});

    try{
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: "Relatório de retrabalhos e perdas 2D",
          text: "Relatório de retrabalhos e perdas 2D"
        });
      } else {
        baixarImagem();
        alert("Seu celular/navegador não permite compartilhar arquivo direto. A imagem foi baixada: envie no WhatsApp pela galeria.");
      }
    } catch (err){
      console.error(err);
      alert("Compartilhamento cancelado ou não suportado.");
    }
  }

  calcularTotal();
</script>

</body>
</html>
